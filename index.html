<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowball - Media Organized</title>
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/themes.css">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="image_widths_heights.json" as="fetch" crossorigin>
</head>
<body>
    <!-- Add any text here if you so desire; the images won't be drawn over it. -->
    
    <!-- Main container for images -->
    <div id="container"></div>
    
    <!-- Modular JavaScript -->
    <script type="module">
        // Import modules
        import { EventBus } from './scripts/core/EventBus.js';
        import { StorageManager } from './scripts/core/StorageManager.js';
        import { StateManager } from './scripts/core/StateManager.js';
        import { ImageContainer } from './scripts/components/ImageContainer.js';
        import { ThemeToggle } from './scripts/components/ThemeToggle.js';
        import { ResetButton } from './scripts/components/ResetButton.js';
        import { SavedIndicator } from './scripts/components/SavedIndicator.js';
        import { DragHandler } from './scripts/interactions/DragHandler.js';
        import { ResizeHandler } from './scripts/interactions/ResizeHandler.js';
        import { LinkPreviewLoader } from './scripts/LinkPreviewLoader.js';

        class SnowballApp {
            constructor() {
                this.eventBus = new EventBus();
                this.storageManager = new StorageManager();
                this.stateManager = new StateManager(this.eventBus, this.storageManager);
                this.container = document.getElementById('container');
                this.positions = [];
                this.containers = new Map();
                this.dragHandler = new DragHandler(this.eventBus, this);
                this.resizeHandler = new ResizeHandler(this.eventBus, this);
                this.linkLoader = new LinkPreviewLoader();
                
                // UI Components
                this.themeToggle = new ThemeToggle(this.eventBus, this.stateManager);
                this.resetButton = new ResetButton(this.eventBus, this.stateManager);
                this.savedIndicator = new SavedIndicator(this.eventBus);
                
                // Enable debug mode if requested
                if (new URLSearchParams(window.location.search).has('debug')) {
                    this.setDebugMode(true);
                }
            }

            setDebugMode(enabled) {
                this.eventBus.setDebugMode(enabled);
                this.storageManager.setDebugMode(enabled);
                this.stateManager.setDebugMode(enabled);
                this.dragHandler.setDebugMode(enabled);
                this.resizeHandler.setDebugMode(enabled);
                this.themeToggle.setDebugMode(enabled);
                this.resetButton.setDebugMode(enabled);
                this.savedIndicator.setDebugMode(enabled);
            }

            async init() {
                try {
                    console.log('SnowballApp: Starting initialization...');
                    
                    // Render UI components
                    this.themeToggle.render();
                    this.resetButton.render();
                    this.savedIndicator.render();
                    
                    // Apply saved theme
                    const savedTheme = this.stateManager.getTheme();
                    this.themeToggle.setTheme(savedTheme);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Load images and links
                    await this.loadImages();
                    await this.loadLinks();
                    
                    console.log('SnowballApp: Initialization complete');
                    this.eventBus.emit('app:ready', { timestamp: Date.now() });
                    
                } catch (error) {
                    console.error('SnowballApp: Initialization failed:', error);
                }
            }

            setupEventListeners() {
                this.eventBus.on('drag:end', this.handleDragEnd.bind(this));
                this.eventBus.on('resize:end', this.handleResizeEnd.bind(this));
                this.eventBus.on('positions:reset', this.handleReset.bind(this));
            }

            async loadImages() {
                console.log('SnowballApp: Loading images...');
                
                try {
                    // Load metadata
                    const response = await fetch('image_widths_heights.json');
                    const data = await response.json();
                    console.log('SnowballApp: Loaded metadata for', data.length, 'images');

                    // Check for saved states
                    const savedStates = this.stateManager.getAllImageStates();
                    const hasSavedStates = Object.keys(savedStates).length > 0;
                    
                    // Shuffle if no saved states
                    const processedData = hasSavedStates ? data : this.shuffleArray([...data]);

                    // Load images progressively
                    for (let i = 0; i < processedData.length; i++) {
                        const [filename, [width, height]] = processedData[i];
                        
                        try {
                            await this.loadImage(filename, width, height, i);
                            console.log(`SnowballApp: Loaded ${i + 1}/${processedData.length}: ${filename}`);
                            
                            // Add delay between images
                            if (i < processedData.length - 1) {
                                await this.delay(100);
                            }
                        } catch (error) {
                            console.error(`SnowballApp: Failed to load ${filename}:`, error);
                        }
                    }

                    console.log('SnowballApp: All images loaded');
                } catch (error) {
                    console.log('SnowballApp: No images found, continuing without images');
                }
            }

            async loadLinks() {
                console.log('SnowballApp: Loading links...');
                
                try {
                    // Load links from markdown
                    const links = await this.linkLoader.loadLinksFromMarkdown();
                    console.log('SnowballApp: Loaded', links.length, 'links');

                    // Load links progressively
                    for (let i = 0; i < links.length; i++) {
                        const url = links[i];
                        
                        try {
                            await this.loadLink(url, i);
                            console.log(`SnowballApp: Loaded link ${i + 1}/${links.length}: ${url}`);
                            
                            // Add delay between links
                            if (i < links.length - 1) {
                                await this.delay(200);
                            }
                        } catch (error) {
                            console.error(`SnowballApp: Failed to load link ${url}:`, error);
                        }
                    }

                    console.log('SnowballApp: All links loaded');
                } catch (error) {
                    console.log('SnowballApp: No links found or failed to load links');
                }
            }

            async loadImage(filename, originalWidth, originalHeight, index) {
                // Calculate scaled size
                const goalPixels = 150000;
                const actualPixels = originalWidth * originalHeight;
                let scaledWidth, scaledHeight;

                if (actualPixels / goalPixels > 16) {
                    scaledWidth = Math.floor(originalWidth / 8);
                    scaledHeight = Math.floor(originalHeight / 8);
                } else if (actualPixels / goalPixels > 4) {
                    scaledWidth = Math.floor(originalWidth / 4);
                    scaledHeight = Math.floor(originalHeight / 4);
                } else {
                    scaledWidth = Math.floor(originalWidth / 2);
                    scaledHeight = Math.floor(originalHeight / 2);
                }

                // Ensure width doesn't exceed screen width
                const screenWidth = this.container.getBoundingClientRect().width || window.innerWidth;
                if (scaledWidth + 10 > screenWidth) {
                    scaledWidth = screenWidth - 10;
                    scaledHeight = Math.floor(scaledHeight * (scaledWidth / (originalWidth / 2)));
                }

                // Check for saved state
                const savedState = this.stateManager.getImageState(filename);
                let position, size;

                if (savedState) {
                    position = savedState.position;
                    size = savedState.size;
                } else {
                    position = this.calculatePosition(scaledWidth, scaledHeight, index);
                    size = [scaledWidth, scaledHeight];
                }

                this.positions.push(position);

                // Create image container
                const container = new ImageContainer(
                    filename,
                    {
                        width: size[0],
                        height: size[1],
                        originalWidth: originalWidth,
                        originalHeight: originalHeight
                    },
                    index,
                    this.eventBus
                );

                // Render and position
                const element = container.render();
                container.setPosition(position[0], position[1]);
                container.setSize(size[0], size[1]);

                // Attach interaction handlers
                this.dragHandler.attachTo(element, index);
                this.resizeHandler.attachTo(element, index);

                // Add to DOM
                this.container.appendChild(element);

                // Store reference
                this.containers.set(filename, container);
            }

            async loadLink(url, linkIndex) {
                // Standard link card dimensions
                const cardWidth = 350;
                const cardHeight = 220;
                
                // Create loading preview first
                const loadingPreview = {
                    title: 'Loading...',
                    description: 'Fetching website metadata...',
                    siteName: this.linkLoader.getDomain(url),
                    image: null,
                    favicon: null,
                    type: 'website'
                };
                
                // Calculate index offset (after images)
                const totalIndex = this.positions.length;
                
                // Check for saved state
                const linkId = `link_${url}`;
                const savedState = this.stateManager.getImageState(linkId);
                let position, size;

                if (savedState) {
                    position = savedState.position;
                    size = savedState.size;
                } else {
                    position = this.calculatePosition(cardWidth, cardHeight, totalIndex);
                    size = [cardWidth, cardHeight];
                }

                this.positions.push(position);

                // Create link container with loading state
                const container = this.createLinkContainer(
                    url,
                    loadingPreview,
                    {
                        width: size[0],
                        height: size[1]
                    },
                    totalIndex
                );

                // Render and position
                const element = container.element;
                container.setPosition(position[0], position[1]);
                container.setSize(size[0], size[1]);

                // Attach interaction handlers
                this.dragHandler.attachTo(element, totalIndex);
                this.resizeHandler.attachTo(element, totalIndex);

                // Add to DOM
                this.container.appendChild(element);

                // Store reference
                this.containers.set(linkId, container);
                
                // Fetch real preview data and update the card
                setTimeout(() => {
                    this.linkLoader.fetchLinkPreview(url).then(preview => {
                        console.log('Updating container with preview:', preview);
                        this.updateLinkContainer(container, url, preview);
                    }).catch(error => {
                        console.error('Failed to load preview for:', url, error);
                        // Use minimal fallback preview
                        const fallbackPreview = this.linkLoader.generateFallbackPreview(url);
                        this.updateLinkContainer(container, url, fallbackPreview);
                    });
                }, 1000); // Add delay to see loading state
            }

            createLinkContainer(url, preview, dimensions, index) {
                const domain = this.linkLoader.getDomain(url);
                const linkLoader = this.linkLoader;
                
                const element = document.createElement('div');
                element.className = 'link-container';
                element.style.cssText = `
                    position: absolute;
                    background: var(--link-card-bg);
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: var(--link-card-shadow);
                    cursor: move;
                    user-select: none;
                    transition: box-shadow 0.2s ease, background 0.2s ease;
                    border: 2px solid transparent;
                `;
                
                const hasImage = preview.image && preview.image.trim();
                
                element.innerHTML = `
                    <div style="
                        height: 132px;
                        background: ${hasImage ? `url('${preview.image}') center/cover` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        position: relative;
                        color: white;
                        overflow: hidden;
                    ">
                        ${hasImage ? `
                            <div style="
                                position: absolute;
                                bottom: 8px;
                                right: 8px;
                                width: 24px;
                                height: 24px;
                                background: rgba(255,255,255,0.9);
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 12px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            ">
                                ${preview.favicon ? `<img src="${preview.favicon}" alt="favicon" style="width: 12px; height: 12px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                                <span style="display: ${preview.favicon ? 'none' : 'block'};">🔗</span>
                            </div>
                        ` : `
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                            ">
                                ${preview.favicon ? `<img src="${preview.favicon}" alt="favicon" style="width: 20px; height: 20px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                                <span style="display: ${preview.favicon ? 'none' : 'block'};">🔗</span>
                            </div>
                        `}
                    </div>
                    <div style="padding: 12px;">
                        <div style="
                            font-size: 14px;
                            font-weight: 600;
                            color: var(--link-card-text-primary);
                            margin-bottom: 4px;
                            line-height: 1.2;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        ">${preview.title}</div>
                        <div style="
                            color: var(--link-card-text-secondary);
                            font-size: 11px;
                            margin-bottom: 6px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        ">${preview.siteName || domain}</div>
                        <div style="
                            color: var(--link-card-text-muted);
                            font-size: 11px;
                            line-height: 1.3;
                            overflow: hidden;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                        ">${preview.description}</div>
                        ${preview.type && preview.type !== 'website' ? `
                            <div style="
                                margin-top: 6px;
                                font-size: 10px;
                                color: var(--link-card-text-muted);
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                opacity: 0.8;
                            ">${preview.type}</div>
                        ` : ''}
                    </div>
                    <div class="resize-handle" style="
                        position: absolute;
                        bottom: 0;
                        right: 0;
                        width: 20px;
                        height: 20px;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        cursor: se-resize;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        border-radius: 12px 0 12px 0;
                    "></div>
                `;

                // Add hover effects
                element.addEventListener('mouseenter', () => {
                    element.style.boxShadow = 'var(--link-card-shadow-hover)';
                    element.querySelector('.resize-handle').style.opacity = '0.7';
                });
                
                element.addEventListener('mouseleave', () => {
                    element.style.boxShadow = 'var(--link-card-shadow)';
                    element.querySelector('.resize-handle').style.opacity = '0';
                });

                // Add click to open link
                element.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('resize-handle')) {
                        window.open(url, '_blank');
                    }
                });

                return {
                    element: element,
                    url: url,
                    index: index,
                    
                    setPosition(x, y) {
                        element.style.left = x + 'px';
                        element.style.top = y + 'px';
                    },
                    
                    setSize(width, height) {
                        element.style.width = width + 'px';
                        element.style.height = height + 'px';
                    },
                    
                    getPosition() {
                        return [
                            parseInt(element.style.left) || 0,
                            parseInt(element.style.top) || 0
                        ];
                    },
                    
                    getSize() {
                        return [
                            parseInt(element.style.width) || dimensions.width,
                            parseInt(element.style.height) || dimensions.height
                        ];
                    },
                    
                    getIndex() {
                        return index;
                    },
                    
                    destroy() {
                        if (element.parentNode) {
                            element.parentNode.removeChild(element);
                        }
                    },
                    
                    updateContent(newPreview) {
                        const domain = linkLoader.getDomain(url);
                        const hasImage = newPreview.image && newPreview.image.trim();
                        
                        element.innerHTML = `
                            <div style="
                                height: 132px;
                                background: ${hasImage ? `url('${newPreview.image}') center/cover` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                position: relative;
                                color: white;
                                overflow: hidden;
                            ">
                                ${hasImage ? `
                                    <div style="
                                        position: absolute;
                                        bottom: 8px;
                                        right: 8px;
                                        width: 24px;
                                        height: 24px;
                                        background: rgba(255,255,255,0.9);
                                        border-radius: 4px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 12px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                    ">
                                        ${newPreview.favicon ? `<img src="${newPreview.favicon}" alt="favicon" style="width: 12px; height: 12px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                                        <span style="display: ${newPreview.favicon ? 'none' : 'block'};">🔗</span>
                                    </div>
                                ` : `
                                    <div style="
                                        width: 40px;
                                        height: 40px;
                                        background: rgba(255,255,255,0.2);
                                        border-radius: 8px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 18px;
                                    ">
                                        ${newPreview.favicon ? `<img src="${newPreview.favicon}" alt="favicon" style="width: 20px; height: 20px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                                        <span style="display: ${newPreview.favicon ? 'none' : 'block'};">🔗</span>
                                    </div>
                                `}
                            </div>
                            <div style="padding: 12px;">
                                <div style="
                                    font-size: 14px;
                                    font-weight: 600;
                                    color: var(--link-card-text-primary);
                                    margin-bottom: 4px;
                                    line-height: 1.2;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                ">${newPreview.title}</div>
                                <div style="
                                    color: var(--link-card-text-secondary);
                                    font-size: 11px;
                                    margin-bottom: 6px;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    white-space: nowrap;
                                ">${newPreview.siteName || domain}</div>
                                <div style="
                                    color: var(--link-card-text-muted);
                                    font-size: 11px;
                                    line-height: 1.3;
                                    overflow: hidden;
                                    display: -webkit-box;
                                    -webkit-line-clamp: 2;
                                    -webkit-box-orient: vertical;
                                ">${newPreview.description}</div>
                                ${newPreview.type && newPreview.type !== 'website' ? `
                                    <div style="
                                        margin-top: 6px;
                                        font-size: 10px;
                                        color: var(--link-card-text-muted);
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        opacity: 0.8;
                                    ">${newPreview.type}</div>
                                ` : ''}
                            </div>
                            <div class="resize-handle" style="
                                position: absolute;
                                bottom: 0;
                                right: 0;
                                width: 20px;
                                height: 20px;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                cursor: se-resize;
                                opacity: 0;
                                transition: opacity 0.2s ease;
                                border-radius: 12px 0 12px 0;
                            "></div>
                        `;
                        
                        // Re-add event listeners
                        element.addEventListener('mouseenter', () => {
                            element.style.boxShadow = 'var(--link-card-shadow-hover)';
                            element.querySelector('.resize-handle').style.opacity = '0.7';
                        });
                        
                        element.addEventListener('mouseleave', () => {
                            element.style.boxShadow = 'var(--link-card-shadow)';
                            element.querySelector('.resize-handle').style.opacity = '0';
                        });

                        element.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('resize-handle')) {
                                window.open(url, '_blank');
                            }
                        });
                    }
                };
            }
            
            updateLinkContainer(container, url, preview) {
                console.log('updateLinkContainer called with:', { container, url, preview });
                if (container && container.updateContent) {
                    console.log('Calling updateContent...');
                    container.updateContent(preview);
                } else {
                    console.error('Container or updateContent method not found');
                }
            }

            calculatePosition(width, height, index) {
                const screenWidth = this.container.getBoundingClientRect().width || window.innerWidth;
                const minSpacing = 20;
                
                // Simple grid placement with overlap detection
                let searchHeight = 600;
                
                while (searchHeight < 5000) {
                    for (let y = 0; y <= searchHeight - height; y += 50) {
                        for (let x = 0; x <= screenWidth - width; x += 50) {
                            if (!this.wouldOverlap(x, y, width, height)) {
                                return [x, y];
                            }
                        }
                    }
                    searchHeight += 100;
                }
                
                // Fallback: simple grid
                const cols = Math.max(1, Math.floor(screenWidth / (width + minSpacing)));
                const row = Math.floor(index / cols);
                const col = index % cols;
                
                return [col * (width + minSpacing), row * (height + minSpacing)];
            }

            wouldOverlap(x, y, width, height) {
                const minSpacing = 20;
                
                for (let i = 0; i < this.positions.length; i++) {
                    const [otherX, otherY] = this.positions[i];
                    const otherContainer = Array.from(this.containers.values())[i];
                    if (!otherContainer) continue;
                    
                    const otherSize = otherContainer.getSize();
                    const [otherWidth, otherHeight] = otherSize;
                    
                    if (x < (otherX + otherWidth + minSpacing) && 
                        (x + width + minSpacing) > otherX && 
                        (y + height + minSpacing) > otherY && 
                        y < (otherY + otherHeight + minSpacing)) {
                        return true;
                    }
                }
                
                return false;
            }

            handleDragEnd(data) {
                const { index, position } = data;
                this.positions[index] = [position.x, position.y];
                
                const itemId = this.getItemIdByIndex(index);
                if (itemId) {
                    const container = this.containers.get(itemId);
                    const size = container ? container.getSize() : [100, 100];
                    this.stateManager.setImageState(itemId, {
                        position: [position.x, position.y],
                        size: size
                    });
                }
            }

            handleResizeEnd(data) {
                const { index, size } = data;
                
                const itemId = this.getItemIdByIndex(index);
                if (itemId) {
                    const container = this.containers.get(itemId);
                    const position = container ? container.getPosition() : [0, 0];
                    this.stateManager.setImageState(itemId, {
                        position: position,
                        size: [size.width, size.height]
                    });
                }
            }

            handleReset() {
                // Clear containers
                for (const container of this.containers.values()) {
                    container.destroy();
                }
                this.containers.clear();
                this.positions = [];
                this.container.innerHTML = '';
                
                // Reload images
                this.loadImages();
            }

            getItemIdByIndex(index) {
                const containers = Array.from(this.containers.entries());
                for (const [itemId, container] of containers) {
                    if (container.getIndex() === index) {
                        return itemId;
                    }
                }
                return null;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize app
        const app = new SnowballApp();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        // Make available for debugging
        window.SnowballApp = app;
    </script>
    
    <!-- Fallback for browsers without module support -->
    <script nomodule>
        document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;"><h2>Browser Not Supported</h2><p>This application requires a modern browser with ES6 module support.</p><p>Please update your browser or use Chrome, Firefox, Safari, or Edge.</p></div>';
    </script>
</body>
</html>
